---
title: "Suicide Prevention and Analysis"
output: html_notebook
---


```{r setup, include=FALSE}
library(tidyverse)
library(gridExtra)
library(factoextra)
library(MASS)
theme_set(theme_gray())
```


**Suicide Understanding and Prevention**

This notebook contains the analysis of a suicide dataset, which was the final
assignment of the Statistical data analysis course.

## 1. Exploratory data analysis

```{r include=FALSE}
# Load the dataset
load(file="data/suicide.RData")
```

I begin by inspecting whether the dataset contains any NA values that would need to be taken care of.
```{r}
data %>% is.na() %>% colSums()
```
Did all of the included countries contribute the same amount of data? Are there
any countries that reported their statistics far less often than other countries?

```{r}
years.count <- data %>% group_by(continent, country) %>%
  summarise(count = n_distinct(year)) %>%
  arrange(desc(count))

years.count %>%
  ggplot(aes(x = count, fill = continent)) +
  scale_x_continuous(n.breaks = 31) +
  geom_bar()
```


We can see that there are some countries that contributed only 3 years worth of
data or less.


### Suicide rate

Throughout the majority of this notebook, I will be working with suicide rates rather than with concrete numbers
of total suicides. The reason for this is that it allows us to perform better comparisons of suicide prevalence
between different countries and continents, as the populations of different areas differ, and the total number of
suicides in a population is correlated with the size of the population.

```{r}
country.summary <- data %>% group_by(year) %>%
  summarise(population = sum(population),
            suicides_no = sum(suicides_no))

cor(x = country.summary$population, y = country.summary$suicides_no)
```

If we wanted to be even more rigorous with our analysis, we could standardize our suicide rates by age distribution.


### Global trend inspection

The first thing that we can inspect is the progression of suicide rates worldwide during the time period 1985-2015.

```{r}

global.suicide.rate <- data %>% group_by(year) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000
  ) 

global.suicide.rate %>%
  ggplot(aes(x = year, y = suicides_per_100k)) +
  geom_point(color="orange", size=2.4) +
  geom_line(color="orange", size=1.1) +
  labs(
    title = "Worldwide Suicide Rates",
    x = "Year", y = "Suicides per 100k people"
  ) +
  scale_x_continuous(breaks = seq(1985, 2015, 2))
  
```

This figure shows that there has been a great rise in suicides throughout the years 1989 and 1995.
However, with a few exceptions, the suicide rate seems to be on decline ever since then.

```{r}
differences <- data.frame(
  difference = tail(global.suicide.rate$suicides_per_100k, -1) - head(global.suicide.rate$suicides_per_100k, -1),
  year = tail(global.suicide.rate$year, -1))

differences <- differences %>%
  mutate(changeNotPositive = difference <= 0)

differences %>%
  ggplot(aes(x = year, y = difference, color = changeNotPositive)) +
  geom_segment(aes(x = year, xend = year, y = 0, yend = difference)) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(1986, 2015, 2)) +
  scale_y_continuous(breaks = seq(-1, 1.5, 0.5)) +
  theme(legend.position = "none") +
  labs(title = "Change in suicide rate in time",
       subtitle = "Shows the change in suicide rate from the previous year",
       x = "Year", y = "Difference")
```
The figure above shows us the differences in suicide rates between two subsequent years.

```{r fig.height=7}

continent_overall_plot <- data %>% group_by(continent) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep"
  ) %>%
  ggplot(aes(x = continent, y = suicides_per_100k, fill = continent)) +
  geom_bar(stat = "identity") +
  labs(title = "Overall differences in suicide rates between continents",
       x = "Continent", y = "Suicides per 100k people") +
  theme(legend.position = "none")

continent_by_year_plot <- data %>% group_by(year, continent) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep"
  ) %>%
  ggplot(aes(x = year, y = suicides_per_100k, color=continent)) +
  geom_line() +
  geom_point(size=0.8) +
  scale_x_continuous(breaks = seq(1985, 2015, 5)) +
  facet_wrap(~ continent, ncol = 1, scales = "free_y") +
  labs(title = "Suicide Rate By Continent In Time",
       x = "Year", y = "Suicides per 100k people") +
  theme(legend.position = "none")

grid.arrange(continent_overall_plot, continent_by_year_plot, ncol = 2)
```



```{r}
data %>%
  filter(continent == "Africa") %>%
  group_by(country) %>%
  summarise(reports = n_distinct(year)) %>%
  arrange(reports)
```

```{r fig.height = 6}

data_europe <- data %>% filter(continent == "Europe") %>%
  group_by(country) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep"
  ) %>%
  arrange(desc(suicides_per_100k))

data_europe %>%
  ggplot(aes(x = reorder(country, suicides_per_100k), y = suicides_per_100k, fill = suicides_per_100k)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_c() +
  coord_flip() +
  theme(legend.position = "none") +
  labs(title = "Overall Suicide Rates in European countries",
       x = "Country", y = "Suicides per 100k people")
  
```

```{r fig.height = 6}

data_europe %>%
  ggplot(aes(x = reorder(country, suicides_no), y = suicides_no, fill = suicides_no)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_c() +
  coord_flip() +
  theme(legend.position = "none") +
  labs(title = "Number of suicides in European countries",
       x = "Country", y = "Number of suicides")
  
```

### Differences between sexes

```{r}
data %>% group_by(year, sex) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep") %>%
  ggplot(aes(x = year, y = suicides_per_100k, color=sex)) +
  geom_line(size=1.1) + 
  geom_point(size=2.4) +
  labs(title = "Global Differences in Suicide Rates Between Sexes",
       x = "Year", y = "Suicides per 100k people")
```

It is clear that the male part of the population is at a higher risk of suicide
than its female counterpart. Another somewhat interesting observation is that
the change in suicide rate of women in time is not as pronounced as is the
change of suicide rate of men.

```{r}
data %>% group_by(continent, sex) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep"
  ) %>%
  ggplot(aes(x = continent, y = suicides_per_100k, fill = sex)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_y_continuous(breaks = seq(0, 40, 5)) +
  coord_flip() +
  theme(legend.position = "bottom") +
  labs(title = "Overall differences in suicide rates between the continents",
       subtitle = "along with differences between sexes within individual continents",
       x = "Continent", y = "Suicides per 100k people")
```
We can also inspect the differences between the sexes on within individual
continents. This again reveals the same pattern for all of the continents,
that men 

```{r fig.height=7, fig.width=7}
data %>% group_by(continent, sex, year) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep"
  ) %>%
  ggplot(aes(x = year, y = suicides_per_100k, color = sex)) +
  geom_line() +
  geom_point() +
  facet_wrap(~ continent, ncol = 1, scales = "free_y", strip.position = "right") +
  scale_x_continuous(breaks = seq(1985, 2015, 2)) +
  theme(legend.position = "bottom")
```
The suicide rates of women are consistently lower than those of men across all
of the inspected continents.

### Age

```{r}
data %>% group_by(year, age) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep") %>%
  ggplot(aes(x = year, y = suicides_per_100k, color = age)) +
  geom_line() +
  geom_point(size = 0.9) +
  scale_x_continuous(breaks = seq(1985, 2015, 2)) +
  labs(title = "Relationship between suicide rate and age",
       x = "Year", y = "Suicides per 100k people")
```

```{r fig.height=10, fig.width=8}
data %>% group_by(continent, year, age) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep") %>%
  ggplot(aes(x = year, y = suicides_per_100k, color = age)) +
  geom_line() +
  geom_point(size = 0.9) +
  scale_x_continuous(breaks = seq(1985, 2015, 2)) +
  facet_wrap(~continent, ncol = 1) +
  labs(title = "Relationship between suicide rate and age within individual continents",
       x = "Year", y = "Suicides per 100k people")
```



### Correlation Between GDP and Suicide Rates

Using our dataset, we can also try to find out whether the gross domestic product
of a country affects its suicide rate. 

```{r}

data %>% group_by(continent, country) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    mean_gdp_per_capita = mean(gdp_per_capita),
    .groups = "keep") %>%
  ggplot(aes(x = mean_gdp_per_capita, y = suicides_per_100k, color = continent)) +
  geom_point() +
  labs(title = "Relationship between suicide rate and GDP per capita",
       subtitle = "Both variables are represented as means from the time period 1985-2015",
       x = "GDP per capita [$]", y = "Suicides per 100k people")
  

```
This figure does not seem to reveal any relationship between these variables. We can also try to calculate the correlations
between these two variables over the same time interval for each of the countries individually. The correlations were computed
using Spearman's rho, since the relationship between the two variables is not expected to be linear.

```{r}

correlation.gdp.suicide <- data.frame()

for (c in levels(data$country)) {

  country.data <- data %>% filter(country == c) %>%
    group_by(country, year, gdp_per_capita) %>%
    summarise(
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep")
  
  if (nrow(country.data) < 10) {
    next
  }
  
  corr <- cor(x = country.data$gdp_per_capita, y = country.data$suicides_per_100k, method = "spearman")
  
  correlation.gdp.suicide <- rbind(
    correlation.gdp.suicide,
    list(
      country = c,
      correlation = corr
    )
  )
}


correlation.gdp.suicide <- arrange(correlation.gdp.suicide, correlation.gdp.suicide$correlation)

```

```{r}
head(correlation.gdp.suicide)
tail(correlation.gdp.suicide)
```

We can see that this provided us with a much more better insight into the data, and that there is truly a relationship
between the suicide rates within a country and gross domestic product of the country. The relationship seems to be very
strong for a 

```{r fig.width=8}

top.corr.countries <- head(correlation.gdp.suicide)$country
top.corr.correlations <- head(correlation.gdp.suicide)$correlation

my_labeller <- function(countries) {
  correlation <- map(
    countries,
    function(x) correlation.gdp.suicide[correlation.gdp.suicide$country == x, ]$correlation
  ) %>% unlist
  correlation <- round(correlation, digits = 2)
  result <- paste(as.character(countries), ", rho = ", correlation, sep = "")
}

data %>% filter(country %in% top.corr.countries) %>%
  group_by(country, year, gdp_per_capita) %>%
  summarise( 
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep") %>%
  mutate(country_order = factor(country, levels = top.corr.countries)) %>%
  ggplot(aes(x = gdp_per_capita, y = suicides_per_100k, color = country_order)) +
  geom_point() +
  scale_colour_viridis_d(end = 0.8) +
  facet_wrap(~ country_order, scales = "free",
             labeller = as_labeller(my_labeller)) +
  labs(title = "Countries with the largest negative correlation of gross domestic product and suicide rate",
       subtitle = "Correlation is reported using Spearman's rho",
       x = "GDP [$]", y = "Suicides per 100k people") +
  theme(legend.position = "none")

```

It is also worth noting that all of these
countries are European.

```{r fig.width=8}

top.corr.countries <- head(arrange(correlation.gdp.suicide, desc(correlation.gdp.suicide$correlation)))
top.corr.countries <- top.corr.countries$country

my_labeller <- function(countries) {
  correlation <- map(
    countries,
    function(x) correlation.gdp.suicide[correlation.gdp.suicide$country == x, ]$correlation
  ) %>% unlist
  correlation <- round(correlation, digits = 2)
  result <- paste(as.character(countries), ", rho = ", correlation, sep = "")
}

data %>% filter(country %in% top.corr.countries) %>%
  group_by(country, year, gdp_per_capita) %>%
  summarise(
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
    .groups = "keep") %>%
  mutate(country_order = factor(country, levels = top.corr.countries)) %>%
  ggplot(aes(x = gdp_per_capita, y = suicides_per_100k, color = country_order)) +
  geom_point() +
  scale_colour_viridis_d(begin = 0.8, end = 0) +
  facet_wrap(~ country_order, scales = "free",
             labeller = as_labeller(my_labeller)) +
  labs(title = "Countries with the largest correlation of gross domestic product and suicide rate",
       subtitle = "Correlation is reported using Spearman's rho",
       x = "GDP [$]", y = "Suicides per 100k people") +
  theme(legend.position = "none")
```


```{r}

data %>%
  filter(country %in% correlation.gdp.suicide$country) %>%
  group_by(continent, country) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    gdp_per_capita = mean(gdp_per_capita),
    .groups = "keep") %>%
  inner_join(correlation.gdp.suicide, by = "country") %>%
  ggplot(aes(x = correlation, y = suicides_per_100k, color = continent)) +
  geom_point() +
  labs(title = "Relationship between suicide rate and its correlation with GDP",
       subtitle = "Correlation is reported using Spearman's Rho",
       x = "Correlation", y = "Suicides per 100k people")

```
It seems that the countries, where the suicide rate is highly correlated with the gross domestic
product, tend to have higher suicide rates than the countries where the correlation with GDP
is not very strong. This can be observed on both ends of the correlation's value range, however it is
far more pronounced for countries that achieve a negative correlation.
It is also apparent that the majority of countries that achieve a high correlation is European.

```{r fig.height=4, fig.width=8}

countries.continent <- distinct(data[c("country", "continent")])

correlation.gdp.suicide %>%
  inner_join(countries.continent, by = "country") %>%
  filter(continent == "Europe") %>%
  ggplot(aes(x = reorder(country, correlation), y = correlation, fill = correlation)) +
  geom_bar(stat = "identity") +
  scale_fill_viridis_c() +
  scale_y_continuous(limits = c(-1, 1)) +
  labs(title = "Correlations of European countries",
       x = "Country", y = "Correlation") +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
        legend.position = "none")

```

We can see that most of the European countries truly achieve large negative correlations of
suicide rates and GDP. However, there are a few exceptions, where these two variables
are correlated positively.


Correlation between suicide rate and alcohol consumption.

```{r}
data_japan <- data %>% filter(country == "Japan")

data_japan %>% group_by(country, year) %>%
  summarise(
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
      .groups = "keep"
  ) %>%
  ggplot(aes(x = year, y = suicides_per_100k, color = country)) +
  geom_line() +
  geom_point() +
  theme(legend.position = "none")

data_japan %>% group_by(country, year, age) %>%
  summarise(
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
      .groups = "keep"
  ) %>%
  ggplot(aes(x = year, y = suicides_per_100k, color = age)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = seq(1985, 2015, 2)) +
  labs(title = "Differences between age groups in Japan in time",
       x = "Year", y = "Suicides per 100k people")

```


### Clustering

```{r}
clustering.data <- data %>%
  filter(country %in% correlation.gdp.suicide$country) %>%
  group_by(country) %>%
  summarise(
    population = sum(population),
    suicides_no = sum(suicides_no),
    suicides_per_100k = (suicides_no / population) * 100000,
    gdp_per_capita = mean(gdp_per_capita)) %>%
  inner_join(correlation.gdp.suicide, by = "country") %>%
  mutate(suicides_per_100k = scale(suicides_per_100k),
         correlation = scale(correlation)) %>%
  dplyr::select("country", "correlation", "suicides_per_100k")

clustering.data.numeric <- clustering.data %>% dplyr::select(correlation, suicides_per_100k)

clustering <- kmeans(clustering.data.numeric, 6)

# clustering.data %>% cbind(cluster = as.factor(clustering$cluster)) %>%
#   ggplot(aes(x = correlation, y = suicides_per_100k, color = cluster)) +
#   scale_color_viridis_d() +
#   geom_point() +
#   geom_point(data = data.frame(clustering$centers, cluster = factor(c(1, 2, 3))), shape)

fviz_cluster(clustering, data = clustering.data.numeric, labelsize = 0) +
  labs(title = "Clustering countries based on their dependence on GDP",
       subtitle = "Both features have been normalized",
       x = "GDP and Suicide rate correlation")


```

```{r}
clustering.data %>% cbind(cluster = clustering$cluster) %>%
  filter(cluster == 5) %>%
  pull(country)
```

```{r}
clustering
```


### Dimension Reduction

The $\texttt{generation}$ feature is redundant, since we can assign a generation to a group of population by combining the information
from the features $\texttt{year}$ and $\texttt{age}$.

Furthermore, the features $\texttt{gdp_for_year}$ and $\texttt{gdp_per_capita}$ are mutually redundant. That is because we can always
use one of these features in combination with the sum of total population in a country in a certain year to get the value of the other
feature, e.g. $\texttt{gdp_per_capita} = \frac{\texttt{gdp_for_year}}{\texttt{total_population}}$.


```{r}
data %>% group_by(country, year, gdp_for_year, gdp_per_capita) %>%
  summarise(population = sum(population)) %>%
  mutate(x = as.integer(round(gdp_for_year / population)),
         y = abs(x - gdp_per_capita)) %>%
  pull(y) %>%
  mean
```


### Conclusion




## Hypotheses Testing

Based on the previous analysis I would like to test several hypotheses.

### Suicide rates of men and women

The first hypothesis that I will test is that that men tend to commit
suicide more often than women. Therefore, I will test if the suicide rate of men
was higher than that of women during the time interval 1985-2015.

The null hypothesis is that
$$ \mu_m \leq \mu_w $$ 
and the alternative hypothesis is that
$$ \mu_m > \mu_w $$
where $\mu_m$ and $\mu_w$ are the means of suicide rates of men and women during
the time period 1985-2015, respectively. The confidence level is set to be $\alpha = 0.05$.

In order to test this hypothesis, I will make use of Welch's Two Sample t-test,

Where $\mu_m$ and $\mu_w$ are the mean suicide rates of men and women, respectively.

In order to test this hypothesis, I will make use of the Welch's Two Sample t-test,
which is a modification of Student's t-test supporting unequal variances of the samples.


```{r}

sex.hypothesis.data <- data %>% group_by(year, sex) %>%
    summarise(
      population = sum(population),
      suicides_no = sum(suicides_no),
      suicides_per_100k = (suicides_no / population) * 100000,
      .groups = "keep"
    )

rates.male <- sex.hypothesis.data %>% filter(sex == "Male") %>% pull(suicides_per_100k)
rates.female <- sex.hypothesis.data %>% filter(sex == "Female") %>% pull(suicides_per_100k)

t.test(
  x = rates.male,
  y = rates.female,
  alternative = "greater"
)

```

We can see that the resulting p-value of the Welch's Two Sample t-test
is smaller than our confidence level, and therefore we reject the null hypothesis
in favor of the alternative hypothesis. We have confirmed our initial suspicion,
that is that men have higher suicide rates than women.


### Difference in suicide rates between age groups

Another interesting insight gained from the exploratory analysis was that there
is an apparent difference in suicide rates between individual age groups.





